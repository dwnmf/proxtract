Критические ошибки в логике

1. Неверный парсинг булевых значений в конфиге. Функция safe_bool использует bool(value), из‑за чего строка "false" обрабатывается как True. Это легко приводит к обратной интерпретации флагов из settings.toml и UI. Риски: неожиданные включения compact_mode/skip_empty/use_gitignore. Исправить: распознавать строки {"1","true","yes","on"} как True, {"0","false","no","off"} как False; оставлять default при None/пустых строках. 

2. Ошибочная попытка записывать TOML через stdlib tomllib. В save_config ветка «Python 3.11+ tomllib has dump(s)» некорректна: tomllib read‑only и не имеет dump/dumps. Сейчас код падает и молча уходит в ручную сериализацию. Исправить: использовать только tomli‑w для записи, при его отсутствии явно писать «построение TOML не поддерживается» либо всегда fallback на ручной рендер без попытки tomllib. 

3. Невозможно полностью отключить дефолтные фильтры (skip_*). В FileExtractor используется проверка «if skip_extensions else default», поэтому пустое множество из AppState приводит не к «нет фильтров», а к возврату дефолтного набора. Аналогично для skip_patterns/skip_files. Итог: пользователь не может через конфиг очистить правила. Исправить: трактовать None как «использовать дефолт», а пустое множество как «фильтров нет».  

4. Не создаются директории для файла назначения. В extract() сразу open(output_path, "w"), без mkdir(parents=True). Любой несуществующий каталог вызывает ошибку OSError. Исправить: перед записью создавать output_path.parent. Дополнительно — атомарная запись через временный файл и rename. 

5. Несогласованность прогресса. В TUI «total» считается как количество всех файлов rglob(*), а прогресс увеличивается только на реально обработанные файлы (после фильтров и бинарного детекта). На проектах с множеством пропусков прогресс никогда не дойдёт до 100%. Исправить один из вариантов: а) инкрементировать прогресс на каждом просмотренном файле (visited), или б) предварительно просканировать кандидатов с применением фильтров и вычислить корректный total.  

6. Приоритет include/exclude неочевиден. exclude_patterns и .gitignore проверяются раньше include_override; следовательно, include‑паттерн не может «пробить» исключения и игнор. Если требуемая семантика — «include победитель», порядок проверок нужно поменять или ввести отдельный «force_include». Сейчас: exclude → gitignore → not_included → skip_* → размер/пустота. 

7. Дублированные магические сигнатуры и шумные эвристики бинарности. В binary_signatures ключ PK\x03\x04 указан дважды (zip/docx), что не фатально, но показывает ручной и хрупкий список; сигнатура "SQLite" слишком общая, «RIFF» помечает не только webp. Лучше упростить: сначала быстрые проверки (null‑bytes, контрольные символы), затем mimes (mimetypes) и точечные проверки zip/pdf/png/jpg; опционально — python‑magic при наличии. 

8. Ошибки чтения содержимого попадают в итоговый вывод как текст. _read_file_content возвращает "[ERROR: Could not decode file]" и этот маркер записывается в bundle. Правильнее логировать в stats.errors/ skipped и не засорять результат. 

9. Отсутствует обработка симлинков. rglob() пройдёт по симлинкам; is_file() вернёт True для ссылок на файлы. Это может привести к дублированию и непредсказуемым обходам вне root. Рекомендация: по умолчанию skip для is_symlink(), с флагом allow_symlinks для опытных. 

10. Несоответствие требований покрытия. В pyproject включён --cov-fail-under=80, но coverage.xml демонстрирует множество строк с hits="0". Это гарантированно падающая CI‑шибка при включении quality‑гейтов. Либо поднимать покрытие, либо понизить целевой порог до реального.  

Проблемы UX/UI, влияющие на минимализм

1. Стартовый Source Directory заполняется как parent от output_path, что сбивает с толку: пользователь ожидает cwd или последний root. Исправить: дефолт = текущая рабочая директория; кешировать последний успешный root. 

2. Экран извлечения перегружен лишними шагами: подписи, кнопки и прогресс показаны до старта. Упростить: один экран с двумя полями (Root, Output) и одной кнопкой «Extract». Прогресс и Summary — только после старта/завершения. 

3. Список настроек перегружен для базового сценария. Сейчас на главном экране 10+ параметров. Предлагаю «Базовые» (Output, Max size, .gitignore) и «Расширенные» (include/exclude, token count, tokenizer, clipboard) под collapsible‑секцией или отдельным модальным окном. 

4. Прогресс‑бар и статус сначала инициализируются total=100, затем пересчитываются — визуальный «дёрг». Инициализировать без total либо с «indeterminate» до получения реального total. 

5. Сообщение о неудаче в TUI показывает только текст ошибки, без «попробовать снова» и без быстрого доступа к логам. Добавить кнопку Retry, ссылку «Показать детали» с раскрытием errors. 

6. Копирование в буфер происходит сразу после dismiss модалки, а чтение содержимого целевого файла для больших бандлов может блокировать UI. Перенести копирование перед dismiss или делать его лениво по кнопке «Copy» в Summary. 

7. Текст описаний «Include/Exclude Patterns» говорит «comma separated», но пользователю неочевидно, что шаблон применяется относительно корня. Добавить подсказку с примерами: "src/**, *.md". 

8. Summary перегружает «Bytes» сырым числом. Показать человекочитаемо (KB/MB) и первые 3 причины пропусков с числами, остальное под «ещё…». 

План приведения к минималистичному и отказоустойчивому состоянию (для сеньора)

Фаза 1 — корректность и базовая надёжность

1. Починить парсинг булей в конфиге: внедрить нормализатор строк для True/False. Применить в apply_config и в UI‑парсере для единообразия. Критерий приёмки: строки "false"/"no"/"0" корректно отключают флаги; тесты покрывают эти кейсы.  
2. Исправить сохранение конфига: отказаться от tomllib для записи; использовать tomli‑w, иначе явный fallback без ошибок. Критерий: save_config не бросает исключений при отсутствии tomli‑w и создаёт корректный TOML. 
3. Переписать семантику skip_*: None — дефолт, пустое множество — отключение фильтра. Протянуть через AppState → create_extractor → FileExtractor.**init**. Критерий: пустые skip_* действительно снимают фильтры.  
4. Обеспечить создание директорий и атомарную запись результата: mkdir(parents=True, exist_ok=True), запись во временный файл и rename; опциональная .tmp суффиксация. Критерий: извлечение успешно в несуществующие пути и не оставляет частичных файлов при сбое. 
5. Устранить расхождение прогресса: считать total по всем посещённым путям (visited) либо сделать двухпроходный быстрый подсчёт кандидатов с фильтрами без чтения содержимого; альтернативно поддержать «indeterminate» до первого апдейта total. Критерий: индикатор гарантированно достигает 100%.  
6. Сделать включение «силовым»: если включена опция «force include», include‑паттерны обходят exclude/.gitignore. Иначе задокументировать текущую последовательность. Критерий: тесты для пересечения include и exclude. 

Фаза 2 — минимизация UI

1. Экран Extract: по умолчанию только два поля (Root, Output) и кнопка «Extract». Прятать второстепенные элементы до запуска; прогресс и Summary показывать контекстно после старта/финиша. Критерий: путь до извлечения — один шаг. 
2. Дефолт Root = cwd; запоминать последний успешный Root в памяти/конфиге. Критерий: запуск «в один клик» из корня проекта. 
3. Главный экран: разделить настройки на «Базовые» и «Расширенные» (collapsible или модалка). Критерий: базовый список ≤3 пунктов; расширенные доступны за один ввод. 
4. Улучшить подсказки к паттернам: показать, что они относительны к Root, и дать примеры. Критерий: unit‑тесты на корректную интерпретацию относительных путей. 

Фаза 3 — отказоустойчивость и безопасность данных

1. Обход симлинков: по умолчанию skip is_symlink(); добавить флаг allow_symlinks. Критерий: отсутствие обхода за пределы root при наличии ссылок. 
2. Бинарный детект: убрать дубли сигнатур, сделать pipeline: fast checks (null‑bytes/контрольные), ограниченная таблица сигнатур (png/jpg/gif/pdf/zip), затем попытка декодирования; опционально python‑magic при наличии. Критерий: тесты из набора images/pdf/zip, ложно‑положительные <1%. 
3. Ошибки чтения: заменять вставку «[ERROR…]» на пропуск + запись причины в stats.errors и skipped["other"]. Критерий: результирующий bundle не содержит служебных сообщений. 
4. Лимиты на чтение для гигантских файлов в standard‑mode: soft‑cap (например, 5 МБ на файл) с явным предупреждением в errors. Критерий: стабильная работа на монорепозиториях.

Фаза 4 — наблюдаемость и опыт пользователя

1. Summary: человекочитаемый размер (KB/MB), топ‑3 причин пропуска + «ещё N», список предупреждений сворачиваемый. Критерий: читаемость на одном экране. 
2. Retry/Copy в UI: кнопка «Retry» на ошибке; «Copy to clipboard» в Summary вместо автокопирования после dismiss. Критерий: отсутствие лишних блокировок UI. 
3. Логи: опциональный файл журнала рядом с output (output.log) с полным перечнем пропусков и ошибок.

Фаза 5 — производительность и масштаб

1. Потоковая запись без сортировки полного списка rglob, чтобы не держать каталог целиком в памяти; при необходимости опция «stable order» отдельно. Критерий: стабильная работа на 100k+ файлов.
2. Токены: инициализация tiktoken один раз, возможность «sample‑estimate» для больших файлов. Критерий: время извлечения не деградирует при включённом подсчёте. 

Фаза 6 — тесты/качество

1. Добавить unit‑тесты на булев парсинг и пустые skip_* (очистка фильтров). Критерий: сценарии "false"/"off" и [] проходят. 
2. Тест на mkdir+atomic write: извлечение в несуществующий путь и симулированный сбой посередине.
3. Тесты на прогресс: «все файлы пропущены» и «большинство бинарные» — прогресс всё равно доходит до 100%. 
4. Проверить и синхронизировать порог покрытия с фактическим состоянием; временно снизить порог или усилить покрытие модулей main/tui.  

Быстрые фиксы (вносятся без изменения архитектуры)

— В ExtractScreen по on_mount задавать root = cwd вместо output.parent; скрывать ProgressBar до старта; инициализировать как indeterminate. 
— В save_config убрать ветку tomllib.dumps, оставить tomli‑w либо явный fallback. 
— В FileExtractor.**init** различать None и пустые множества для skip_*; протянуть это из AppState.  
— В extract() перед open() вызывать output_path.parent.mkdir(parents=True, exist_ok=True); писать во временный файл и rename. 
— В _read_file_content ошибки не возвращать как текст; логировать в stats и помечать как skipped["other"]. 
— В подсчёте прогресса увеличивать processed на каждый просмотренный путь либо корректно переоценивать total перед стартом.  
— Привести binary_signatures к минимальному набору без дублей; удалить лишние/шумные сигнатуры. 

Ожидаемый эффект

— Прозрачная и предсказуемая семантика конфигов и фильтров.
— Минимальный «путь до результата» в UI, без когнитивного шума.
— Устойчивость к типовым сбоям (пути, частичная запись, бинарные файлы, симлинки).
— Корректный прогресс на любых репозиториях.
— Готовность к CI‑гейтам и реальным монорепозиториям.

Если нужно, могу сразу проставить конкретные патчи по указанным местам и добавить целевые тесты под каждый пункт.
